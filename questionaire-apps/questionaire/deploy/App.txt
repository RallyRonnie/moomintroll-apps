<!DOCTYPE html>
<html>
<head>
    <title>Questionaire</title>
    <!--  (c) 2016 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Tue Dec 06 2016 13:38:49 GMT-0700 (MST) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Tue Dec 06 2016 13:38:49 GMT-0700 (MST)";
        var STORY    = "F166";
        var BUILDER  = "kcorkan";
        var CHECKSUM = 25495084802;
    </script>
    
    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns) -->
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
             
/**
 * A link that pops up a version dialog box
 */

Ext.define('Rally.technicalservices.InfoLink',{
    extend: 'Rally.ui.dialog.Dialog',
    alias: 'widget.tsinfolink',
    
    /**
     * @cfg {String} informationHtml
     * Additional text to be displayed on the popup dialog (for exmaple,
     * to add a description of the app's use or functionality)
     */
    informationHtml: null,
    
    /**
     * 
     * cfg {String} title
     * The title for the dialog box
     */
    title: "Build Information",
    
    defaults: { padding: 5, margin: 5 },

    closable: true,
     
    draggable: true,

    autoShow: true,
   
    width: 350,
    
    informationalConfig: null,
    
    items: [{xtype:'container', itemId:'information' }],
    
    initComponent: function() {
        var id = Ext.id(this);
        this.title =  "<span class='icon-help'> </span>" + this.title;
        this.callParent(arguments);
    },
    
    _generateChecksum: function(string){
        var chk = 0x12345678,
            i;
        string = string.replace(/var CHECKSUM = .*;/,"");
        string = string.replace(/var BUILDER  = .*;/,"");
        string = string.replace(/\s/g,"");  //Remove all whitespace from the string.
       
        for (i = 0; i < string.length; i++) {
            chk += (string.charCodeAt(i) * i);
        }
   
        return chk;
    },
    
    _checkChecksum: function(container) {
        var deferred = Ext.create('Deft.Deferred');
        var me = this;
        
        Ext.Ajax.request({
            url: document.URL,
            params: {
                id: 1
            },
            success: function (response) {
                text = response.responseText;
                if ( CHECKSUM ) {
                    var stored_checksum = me._generateChecksum(text);
                    if ( CHECKSUM !== stored_checksum ) {
                        deferred.resolve(false);
                        return;
                    }
                }
                deferred.resolve(true);
            }
        });
        
        return deferred.promise;
    },
    
    _addToContainer: function(container){
        var config = Ext.apply({
            xtype:'container',
            height: 200,
            overflowY: true
        }, this.informationalConfig);
        
        container.add(config);
    },
    
    afterRender: function() {
        var app = Rally.getApp();
        
        if ( !Ext.isEmpty( this.informationalConfig ) ) {
            var container = this.down('#information');
            this._addToContainer(container);
            
        }
        
        if (! app.isExternal() ) {
            this._checkChecksum(app).then({
                scope: this,
                success: function(result){
                    if ( !result ) {
                        this.addDocked({
                            xtype:'container',
                            cls: 'build-info',
                            dock: 'bottom',
                            padding: 2,
                            html:'<span class="icon-warning"> </span>Checksums do not match'
                        });
                    }
                },
                failure: function(msg){
                    console.log("oops:",msg);
                }
            });
        } else {
            this.addDocked({
                xtype:'container',
                cls: 'build-info',
                padding: 2,
                dock: 'bottom',
                html:'... Running externally'
            });
        }
        this.callParent(arguments);
    },
    
    beforeRender: function() {
        var me = this;
        this.callParent(arguments);

        if (this.informationHtml) {
            this.addDocked({
                xtype: 'component',
                componentCls: 'intro-panel',
                padding: 2,
                html: this.informationHtml,
                doc: 'top'
            });
        }
        
        this.addDocked({
            xtype:'container',
            cls: 'build-info',
            padding: 2,
            dock:'bottom',
            html:"This app was created by the CA AC Technical Services Team."
        });
        
        if ( APP_BUILD_DATE ) {
            var build_html = Ext.String.format("Built on: {0} <br/>Built by: {1}",
                APP_BUILD_DATE,
                BUILDER);
                
            if ( STORY ) {
                build_html = build_html + "<br/>Source story: " + STORY;
            }
                
            this.addDocked({
                xtype:'container',
                cls: 'build-info',
                padding: 2,
                dock: 'bottom',
                html: build_html
            });
        }
    }
});

/*
 */
Ext.define('Rally.technicalservices.Logger',{
    constructor: function(config){
        Ext.apply(this,config);
    },
    log: function(args){
        var timestamp = "[ " + Ext.util.Format.date(new Date(), "Y-m-d H:i:s.u") + " ]";
        //var output_args = arguments;
        //output_args.unshift( [ "[ " + timestamp + " ]" ] );
        //output_args = Ext.Array.push(output_args,arguments);
        
        var output_args = [];
        output_args = Ext.Array.push(output_args,[timestamp]);
        output_args = Ext.Array.push(output_args, Ext.Array.slice(arguments,0));

        window.console && console.log.apply(console,output_args);
    }

});

Ext.define('CA.agile.technicalservices.Survey',{
    constructor: function(config){
        Ext.apply(this, config);
        this.questionPath = [];
        this.panelPath = [];
        console.log('CA.agile.technicalservices.Survey', this);
    },
    getTitle: function(){
        return this.title;
    },
    getInstructions: function(){
        return this.instructions;
    },
    setRecord: function(record){
        this.record = record;
    },
    getID: function(){
        console.log('getID', this.record.get('FormattedID'));
        return this.record && this.record.get('FormattedID') || "Unknown";
    },
    getRootKey: function(){
        return Ext.Object.getKeys(this.questionMap)[0];
    },
    getInitialContainerConfig: function(){
        var containerKey = this.startContainer;
        this.questionPath = [containerKey];
        return this.getQuestionConfig(containerKey);
    },
    getNextContainerConfig: function(currentContainerKey,selectedChildKey, containerValue){
        //get the next container in the tree.
        this.questionPath.push(selectedChildKey);
        this.questions[selectedChildKey].value = containerValue;
        return this.getQuestionConfig(selectedChildKey);
    },
    getPreviousContainerConfig: function(currentContainerKey,selectedChildKey, containerValue){
        if (containerValue){
            this.questions[selectedChildKey].value = containerValue;
        }
        //now remove the last element from the path
        this.questionPath.pop();
        return this.getQuestionConfig(this.questionPath[this.questionPath.length-1]);
    },
    getQuestionMap: function(questionKey){
        var map = this.questionMap;
        Ext.Array.each(this.questionPath, function(key){
            map = map[key] || null;
            if (!map){ return false; }
            if (questionKey === key){
                return false;
            }
        });
        return map;
    },
    getQuestionConfig: function(key){
        var question = this.questions[key],
            hasChildren = false;
        if (!question){
            return null;
        }

        var childrenKeys = question.children || [],
            children = [];
        Ext.Array.map(childrenKeys, function(c){
            var child = this.questions[c];
            if (child){
                child.key = c;
                hasChildren = (child.children && child.children.length > 0);
                child.value = (question.value === child.key);
                children.push(child);
            }
        }, this);

        return {
            xtype: question.childType,
            instructions: question.childInstructions,
            questions: children,
            record: this.record,
            key: key,
            hasChildren: hasChildren
        };
    },
    submit: function(containerValue){
        var deferred = Ext.create('Deft.Deferred');
       // this.panelPath.push(selectedChildKey);
        this.setValue(containerValue);
       // this.questionPath.push(selectedChildKey);
       // this.questions[selectedChildKey].value = containerValue;

        var updates = {};
        Ext.Array.each(this.panelPath, function(key){
            var panel = this.panels[key];
            if (panel.updates){
                Ext.Object.each(panel.updates, function(field,value){
                    if (Ext.isString(value)){
                        value = value.replace(/\{value}/g, panel.value);
                    }
                    updates[field] = value
                });
            }
            if (panel.options){
                Ext.Array.each(panel.options, function(opt){
                    if (opt.nextKey === panel.value && opt.updates){
                        Ext.Object.each(opt.updates, function(field,value){
                            updates[field] = value
                        });
                    }
                });
            }
        }, this);
        //Ext.Array.each(this.questionPath, function(key){
        //    var question = this.questions[key];
        //    if (question.updates){
        //        Ext.Object.each(question.updates, function(field,value){
        //            if (Ext.isString(value)){
        //                value = value.replace(/\{value}/g, question.value);
        //            }
        //            updates[field] = value
        //        });
        //    }
        //}, this);

        console.log('submit', updates);
        Ext.Object.each(updates, function(field,value){
            this.record.set(field, value);
        }, this);

        this.record.save().then({
            success: function(record){
                deferred.resolve(record);
            },
            failure: function(){
                deferred.reject('Failed to save changes');
            },
            scope: this
        });
        return deferred;
    },
    isFirstButton: function(){
        return (this.questionPath.length === 1);
    },
    isFirst: function(){
        return (this.panelPath.length === 1);
    },
    isLast: function(selectedValue){
        var key = this.getCurrentPanelKey();

        var panelCfg = this.panels[key],
            isLast = true;

        console.log('isLast', key, panelCfg, selectedValue);
        if (panelCfg){
            if (panelCfg.nextKey){
                return false;
            }

            Ext.Array.each(panelCfg.options || [], function(opt){
                if (opt.nextKey && this.panels[opt.nextKey] &&
                    (!selectedValue || selectedValue === opt.nextKey)){
                    isLast = false;
                }
                return isLast;
            }, this);
        }
        return isLast;
    },
    setValue: function(containerValue){
        var containerKey = this.getCurrentPanelKey();
        this.panels[containerKey].value = containerValue;
    },

    getPanelCfg: function(key){
        if (!key){
            key = this.startContainer;
            this.panelPath = [];
        }
        if (!Ext.Array.contains(this.panelPath, key)){
            this.panelPath.push(key);
        }
        return this.panels[key];
    },
    getCurrentPanelKey: function(){
        return this.panelPath[this.panelPath.length-1];
    },
    getPreviousPanelCfg: function(){
        this.panelPath.pop();
        var key = this.getCurrentPanelKey();
        return this.getPanelCfg(key);
    }
});
Ext.define('CA.agile.technicalservices.SurveyConfiguration',{

    model: 'PortfolioItem/Initiative',
    fetch: ['FormattedID','Name'],
    filters: [],

    title: 'Financial Survey',

    startContainer: 'things',

    panels: {
        things: {
            key: 'things',
            type: 'choice',
            text: 'Please select your favorite kind of thing:',
            options: [{
                text: 'I like animals',
                nextKey: 'animals'
            },{
                text: 'I like cars',
                nextKey: 'cars'
            }],
            value: null
        },
        animals: {
            key: 'animals',
            text: 'Please select your favorite kind of animal',
            type: 'choice',
            options: [{
                text: 'I like dogs',
                nextKey: 'dogs'
            },{
                text: 'I like cats',
                nextKey: 'cats',
                updates: {
                    Name: 'I picked cats'
                }
            },{
                text: 'I like birds',
                nextKey: 'birds',
                updates: {
                    Name: 'I picked birds'
                }
            }],
            value: null
        },
        cars: {
            key: 'cars',
            text: 'Please describe your ideal car',
            type: 'description',
            field: 'Description',
            value: null,
            nextKey: 'carColor',
            exampleValue: "Suggested Template:<br/><br/>I want a car with 4 seats and a steering wheel.",
            updates: {
                Description: '{value}',
                Name: 'I picked cars'
            }
        },
        carColor: {
            key: 'carColor',
            text: 'what color would your ideal car be?',
            type: 'description',
            field: 'Notes',
            value: null,
            nextKey: null,
            updates: {
                Notes: '{value}'
            }
        },
        dogs: {
            text: 'Please select your favorite kind of dog',
            type: 'choice',
            key: 'dogs',
            options: [{
                text: 'I like mutts',
                nextKey: 'mutts',
                updates: {
                    Name: 'I like mutts'
                }
            },{
                text: 'I like poodles',
                nextKey: 'poodles',
                updates: {
                    Name: 'I like poodles'
                }
            }],
            value: null
        }
    },

    questions: {
        things: {
            childType: 'surveycontainerradio',
            childInstructions: 'Please select your favorite kind of thing:',
            children: ['animals','cars'],
            key: 'things'
        },
        carDescription:{
            question: 'Please describe your ideal car',
            updates:{
                Description: '{value}'
            },
            field: 'Description',
            exampleValue: 'Expected Description:<br/><br/>I like vintage airstream campers.' ,
            key: 'carDescription'

        },
        'animals': {
            question: 'I like animals more than cars',
            updates: {
                Name: "I like animals",
                Description: "I like animals more than cars"
            },
            childInstructions: 'Please select your favorite kind of animal',
            childType: 'surveycontainerradio',
            children: ['cats','dogs','birds'],
            key: 'animals'
        },
        'cars': {
            question: 'I like cars more than animals',
            updates: {
                Name: "I like cars",
                Description: "I like cars more than animals"
            },
            childInstructions: "Please describe your ideal car",
            childType: 'surveytypedescriptiontemplate',
            children: ['carDescription'],
            key: 'cars'
        },
        'cats': {
            question: 'I like cats the best',
            childInstructions: 'Please select your favorite kind of cat',
            childType: 'surveycontainerradio',
            children: ["maine-coon",'tabby','persian'],
            key: 'cats',
            updates: {
                Name: "I like cats",
                Description: "I like cats"
            }
        },
        'dogs': {
            question: 'I like dogs the most',
            childInstructions: 'Please select your favorite kind of dog',
            childType: 'surveycontainerradio',
            children: ['poodles','goldenRetrievers','mutts'],
            key: 'dogs',
            updates: {
                Name: "I like dogs",
                Description: "I like dogs"
            }
        },
        'birds': {
            question: 'I like birds',
            childInstructions: 'Please select your favorite kind of bird',
            childType: 'surveycontainerradio',
            children: ['blue-jay','cardinal','oriole'],
            key: 'birds',
            updates: {
                Name: "I like birds",
                Description: "I like birds"
            }
        },
        'maine-coon': {
            question: 'Maine-coons with their squeaky voices and huge tails are the best',
            key: 'maine-coon',
            updates: {
                Description: "Maine-coons with their squeaky voices and huge tails are the best"
            }
        },
        'tabby': {
            question: 'Tabby have the best coloring',
            key: 'tabby',
            updates: {
                Description: "Tabby have the best coloring"
            }
        },
        'persian': {
            question: 'Persian cats have attitude',
            key: 'persian',
            updates: {
                Description: "Persian cats have attitude"
            }
        },
        'poodles': {
            question: 'Poodles are awesome because they dont shed',
            key: 'poodles',
            updates: {
                Description: "Poodles are awesome because they dont shed"
            }
        },
        'goldenRetrievers': {
            question: 'Golden Retrievers are so loyal and sweet.',
            key: 'goldenRetrievers',
            updates: {
                Description: 'Golden Retrievers are so loyal and sweet.'
            }
        },
        'mutts': {
            question: 'Mutts are the best',
            key: 'mutts',
            updates: {
                Description: 'Mutts are the best'
            }
        },
        'blue-jay': {
            question: 'Blue jays have the most beautiful colors',
            key: 'blue-jay',
            updates: {
                Description: 'Blue jays have the most beautiful colors'
            }
        },
        'cardinal': {
            question: 'Cardinals are bold and red',
            key: 'cardinal',
            updates: {
                Description: 'Cardinals are bold and red'
            }
        },
        'oriole': {
            question: 'Orioles are a neat bird, but named after a baseball team that loses to the Pirates all the time',
            key: 'oriole',
            updates: {
                Description: 'Orioles are a neat bird, but named after a baseball team that loses to the Pirates all the time'
            }
        }
    }
});
Ext.define('CA.agile.technicalservices.SurveyContainer',{
    extend: 'Ext.container.Container',
    alias: 'widget.surveycontainer',

    config: {
        itemId: 'questionCt'
    },

    constructor: function(config) {
        this.mergeConfig(config);

        this.surveyContainerCfg = config.surveyContainerCfg;
        this.record = config.record;

        this.callParent([this.config]);
    },
    initComponent: function() {

        var cfg = this.surveyContainerCfg,
            items = this._getNoItems();

        if (cfg){
            if (cfg.type === 'description'){
                items = this._getDescriptionItems(cfg);
            } else {
                items =  this._getChoiceItems(cfg);
            }
        }
        this.items = items;
        this.callParent(arguments);
    },
    _getNoItems: function() {
        return [{
            xtype: 'container',
            html: '<div class="survey-title">Survey Completed</div>'
        }];
    },
    _getChoiceItems: function(cfg){
        var items = [];

        if (cfg.options.length > 0){
            items.push({
                xtype: 'container',
                html: cfg.text,
                cls: 'survey-instructions',
                padding: 10,
                margin: 10
            });
            Ext.Array.each(cfg.options, function(opt){
                if (opt){
                    items.push({
                        xtype: 'rallyradiofield',
                        boxLabel: opt.text,
                        name: 'optChoice',
                        inputValue: opt.nextKey,
                        value: cfg.value === opt.nextKey,
                        margin: '20 10 20 30',
                        boxLabelAlign: 'after',
                        boxLabelCls: 'survey-question',
                        listeners: {
                            change: this.choiceUpdated,
                            scope: this
                        }
                    });
                }
            }, this);
        }
        return items;
    },
    choiceUpdated: function(radioBtn){
        if (radioBtn.value === true){
            this.fireEvent('choiceupdated', radioBtn && radioBtn.inputValue);
        }
    },
    _getDescriptionItems: function(cfg){
        var subItems = [{
            xtype: 'rallyrichtexteditor',
            itemId: 'rteDescription',
            value: cfg.value || this.record && this.record.get(cfg.field) || "",
            margin: 5,
            flex: 1,
            frame: true,
            minHeight: 200 + 53,
            width: '50%'
        }];

        if (cfg.exampleValue){
            subItems.push({
                xtype: 'container',
                itemId: 'rteExample',
                padding: 10,
                readOnly: true,
                html: cfg.exampleValue,
                margin: 5,
                minHeight: 200 + 53,
                border: 1,
                style: {
                    borderColor: '#ccc',
                    borderStyle: 'solid',
                    borderRadius: 3
                },
                width: '50%'
            });
        }

        return [{
            xtype: 'container',
            html: cfg.text,
            cls: 'survey-instructions',
            padding: 10
        },{
            xtype: 'container',
            layout: 'hbox',
            padding: 10,
            items: subItems
        }];
    },
    getValue: function() {
        if (!this.surveyContainerCfg){ return null;}

        if (this.surveyContainerCfg.type === 'description'){
            return this.down('#rteDescription').getValue();
        }
        var key = this.down('rallyradiofield[value=true]');
        return key && key.inputValue;
    },
    getNextPanelKey: function(){
        if (!this.surveyContainerCfg){
            return null;
        }

        if (this.surveyContainerCfg.type === 'choice'){
            return this.getValue();
        }
        return this.surveyContainerCfg.nextKey || null;
    },
    validate: function(){
        return true;

        if (!this.surveyContainerCfg){
            return true;
        }

        if (this.surveyContainerCfg.type === 'choice'){
            return this.getValue();
        }
        return this.down('#rteDescription').getValue().length > 0;
    }
});
Ext.define('CA.agile.technicalservices.SurveyDriver', {
    mixins: {
        observable: 'Ext.util.Observable'
    },

    surveyData: null,


    constructor: function (config) {
        this.mixins.observable.constructor.call(this, config);

        this._fetchSurveyData(config).then({
            success: function(data){
                this.surveyData = data;
                this.fireEvent('ready', this);
            },
            failure: function(msg){
                this.fireEvent('problem', msg);
            },
            scope: this
        });
    },
    getFetch: function(){
        return this.surveyData && this.surveyData.fetch || ['FormattedID','Name'];
    },
    getModel: function(){
        return this.surveyData && this.surveyData.model || 'HierarchicalRequirement';
    },
    getFilters: function(){
        return this.surveyData && this.surveyData.filters || [];
    },
    getTitle: function(){},
    getSurveyConfig: function(){
        return this.surveyData;
    },
    getInstuctions: function(){},
    getRootQuestions: function () {
        if (!this.rootQuestions) throw 'DecisionTree: no initial choice(s) specified';
        return this.getQuestions(this.rootQuestions);
    },
    getQuestions: function (questions) {

        if (!questions) return [];
        var list = [];
        for (var i = 0, ln = questions.length; i < ln; i++) {
            var childChoice = this.getQuestion(questions[i]);
            list.push(childChoice);
        }
        return list;

    },
    getQuestion: function (questionKey) {
        if (!(questionKey in this.questions)) return false;
        return this.questions[questionKey];
    },
    getNextQuestions: function(thisQuestion){
        if (!(thisQuestion in this.questions)) return false;
        if (!('children' in this.questions[thisQuestion])) return false;

        var childIds = this.questions[thisQuestion].children;
        return this.getQuestions(childIds);
    },
    _fetchSurveyData: function(config){
        var deferred = Ext.create('Deft.Deferred');

        //todo: retrieve this from preferences
        deferred.resolve(Ext.create('CA.agile.technicalservices.SurveyConfiguration'));

        return deferred.promise;
    }
});

Ext.define('CA.agile.technicalservices.SurveyPanel', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.tssurveypanel',

    requires: [
        'Rally.ui.Button'
    ],

    logger: new Rally.technicalservices.Logger(),
   // border: false,
   // closable: false,
    ui: 'info-box',
    hideCollapseTool: true,
    collapsible: true,
    collapsed: false,
    height: 400,
    width: '100%',
    collapseDirection: 'right',
    headerPosition: 'left',
    header: true,
    cls: 'detail-panel',

    padding: 10,
    overflowY: 'auto',

    config: {
        /**
         * @cfg {Rally.data.wsapi.Model} (required)
         * The record that the new comment belongs to.
         */
        record: null,
        surveyConfig: null,
        nextText: 'Next >',
        submitText: 'Submit',
        previousText: '< Back'
    },

    dockedItems: [{
        xtype: 'container',
        dock: 'top',
        items: [{
            xtype: 'container',
            flex: 1,
            layout: 'hbox',
            items: [{
            //    xtype: 'rallybutton',
            //    cls: 'detail-collapse-button icon-leave',
            //    width: 18,
            //    margin: '0 10 0 25',
            //    userAction: 'Close (X) filter panel clicked',
            //    listeners: {
            //        click: this.close,
            //        scope: this
            //    }
            //},{
                xtype: 'container',
                flex: 1,
                itemId: 'panelTitle',
                tpl: '<tpl><div class="survey-title">{title} for {initiativeID}</div><div class="survey-description">{instructions}</div></tpl>'
            }]
        }]
    },{
        xtype: 'toolbar',
        dock: 'bottom',
        layout: {
            type: 'hbox',
            pack: 'center'
        },
        ui: 'footer',
        itemId: 'footer'
    }],

    bubbleEvents: ['failure'],

    constructor: function(config){
        this.mergeConfig(config);

        this.survey = Ext.create('CA.agile.technicalservices.Survey',config.surveyConfig);
        this.survey.setRecord(this.record);

        this.callParent([this.config]);
    },
    initComponent: function() {

        this.callParent(arguments);

        this.down('#panelTitle').update({
            title: this.survey.getTitle(),
            instructions: this.survey.getInstructions(),
            initiativeID: this.survey.getID()
        });

        this.drawFooter();

        this._initializeSurvey();

    },
    drawFooter: function(){
        this.logger.log('drawFooter');
        this.down('#footer').add([
            {
                xtype: 'rallybutton',
               // cls: 'detail-collapse-button icon-leave',
                text: 'Cancel',
                float: 'left',
                cls: ['commentActionButton', 'commentCancel', 'secondary', 'rly-small'],
                handler: this.close,
                scope: this

            },{
                xtype: 'container',
                flex: 1
            },{

                xtype: 'rallybutton',
                text: this.previousText,
                itemId: 'backButton',
                disabled: true,
                cls: ['commentActionButton', 'commentCancel', 'secondary', 'rly-small'],
                handler: this._previousQuestion,
                scope: this
            },
            {
                xtype: 'rallybutton',
                itemId: 'nextButton',
                text: this.nextText,
                cls: ['commentActionButton', 'commentSave', 'primary', 'rly-small'],
                handler: this._nextQuestion,
                scope: this
            },{
                xtype: 'container',
                flex: 1
            },{
                xtype: 'rallybutton',
                itemId: 'submitButton',
                text: this.submitText,
                cls: ['commentActionButton', 'commentSave', 'primary', 'rly-small'],
                handler: this._submit,
                scope: this,
                float: 'right',
                visible: false
            }
        ]);
        this.down('#submitButton').setVisible(false);
    },
    _cancel: function() {
        this.fireEvent('cancel');
        this.close();
    },
    _submit: function(){


        if (!this._getSurveyContainer().validate()){
            return;
        }

         this.survey.submit(this._getSurveyContainer().getValue()).then({
            success: function(record){
                this.fireEvent('submit', record);
            },
            failure: function(msg){
                this.fireEvent('failure', msg);
            },
            scope: this
        }).always(function(){ this.close(); }, this);
    },
    _nextQuestion: function(){
        if (!this._getSurveyContainer().validate()){
            return;
        }
        this.survey.setValue(this._getSurveyContainer().getValue());
        var cfg = this.survey.getPanelCfg(this._getSurveyContainer().getNextPanelKey());
        this._updatePanel(cfg);
    },
    _previousQuestion: function(){

        var cfg = this.survey.getPreviousPanelCfg();
        this._updatePanel(cfg);
    },
    _initializeSurvey: function(){
        if(!this.rendered){
            this.on('afterrender', this._initializeSurvey, this);
            return;
        }
        var cfg = this.survey.getPanelCfg();
        this._updatePanel(cfg);
    },
    close: function(){
        this.survey.destroy();
        this.destroy();
    },
    _getSurveyContainer: function(){
        return this.down('surveycontainer');
    },
    _updatePanel: function(panelCfg){
        if (this._getSurveyContainer()){ this._getSurveyContainer().destroy(); }

        var ct = this.add({
            xtype: 'surveycontainer',
            surveyContainerCfg: panelCfg,
            record: this.record
        });
        ct.on('choiceupdated', this._updateButtons, this);
        this._updateButtons();
    },
    _updateButtons: function(choiceValue){
        var isLast = this.survey.isLast(choiceValue);

        this.down('#backButton').setDisabled(this.survey.isFirst());
        this.down('#submitButton').setVisible(isLast);
        this.down('#nextButton').setDisabled(isLast);
    }
});
Ext.define("questionaire", {
    extend: 'Rally.app.App',
    componentCls: 'app',
    logger: new Rally.technicalservices.Logger(),
    defaults: { margin: 10 },

    layout: 'hbox',
    items: [
        {xtype:'container',itemId:'grid_box', flex: 1},
        {xtype:'container',itemId:'survey_box'}
    ],

    integrationHeaders : {
        name : "questionaire"
    },
    config: {
        defaultSettings: {

        }
    },
    surveyDriver: null,

    launch: function() {
        Ext.create('CA.agile.technicalservices.SurveyDriver',{
            listeners: {
                ready: this.initializeApp,
                problem: this.showErrorNotification,
                scope: this
            }
        });
    },
    initializeApp: function(surveyDriver){
        this.surveyDriver = surveyDriver;
        this.logger.log('initializeApp', this.surveyDriver);
        var grid = this.getGridBox().add({
            xtype: 'rallygrid',
            storeConfig: {
                model: this.surveyDriver.getModel(),
                fetch: this.surveyDriver.getFetch(),
                filters: this.surveyDriver.getFilters()
            },
            columnCfgs: this.surveyDriver.getFetch()
        });
        grid.on('itemdblclick', this.launchSurvey, this);
    },
    launchSurvey: function(grid, record){
        this.getSurveyBox().removeAll();

        this.logger.log('launchSurvey', record.get('FormattedID'));

        var surveyPanel = this.getSurveyBox().add({
            xtype: 'tssurveypanel',
            width: this.getWidth(),
            surveyConfig: this.surveyDriver.getSurveyConfig(),
            record: record
        });
        surveyPanel.on('submit', this.showSuccess, this);
        surveyPanel.on('failure', this.showErrorNotification, this);
    },
    showSuccess: function(record){
        Rally.ui.notify.Notifier.showUpdate({artifact: record});
    },
    showErrorNotification: function(msg){
        Rally.ui.notify.Notifier.showError({message: msg });
    },
    getGridBox: function(){
        return this.down('#grid_box');
    },
    getSurveyBox: function(){
        return this.down('#survey_box');
    },
    getOptions: function() {
        return [
            {
                text: 'About...',
                handler: this._launchInfo,
                scope: this
            }
        ];
    },
    _launchInfo: function() {
        if ( this.about_dialog ) { this.about_dialog.destroy(); }
        this.about_dialog = Ext.create('Rally.technicalservices.InfoLink',{});
    },
    
    isExternal: function(){
        return typeof(this.getAppId()) == 'undefined';
    }
    
});

            
               Rally.launchApp('questionaire', {
                   name: 'Questionaire'
               });
        });
    </script>
    
    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}


.survey-title {
    color: #888888;
    font-family: ProximaNovaSemiBold, Helvetica, Arial;
    font-size: 12px;
    padding-top: 5px;
}

.survey-description {
    bottom: 7px;
    color: #888888;
    font-family: ProximaNova, Helvetica, Arial;
    font-size: 11px;
    width: 100%;
}

.detail-panel {
    border-left-style: solid;
    border-left-width: 5px;
    border-left-color: #d6d6d6;
}

.detail-collapse-button {
    background-color: transparent;
    color: #a9a9a9;
    font-size: 16px;
    line-height: 12px;
    vertical-align: middle;
    margin: 10px 0 0 0;
    padding: 10px 0 0 0;
    right: 8px;
    top: 16px;
    z-index: 2;
}

.survey-question {
    color: #000000;
    font-family: ProximaNova, Helvetica, Arial;
    font-size: 14px;
    margin-left: 15px;
}

.survey-instructions {
    font-family: ProximaNovaSemiBold, Helvetica, Arial;
    font-size: 14px;
    margin-left: 15px;
    color: #000000;
}
    </style>

</head>
<body></body>
</html>